<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISTU - Intelligent Study Assistant</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; }
        [x-cloak] { display: none !important; }
        
        /* 3D Flip Animation */
        .card-wrap { perspective: 1000px; width: 100%; height: 320px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flipped .card-inner { transform: rotateY(180deg); }
        .face { position: absolute; inset: 0; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-col; align-items: center; justify-content: center; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); text-align: center; }
        .front { background: white; border: 1px solid #e2e8f0; }
        .back { background: #eef2ff; color: #4338ca; transform: rotateY(180deg); border: 2px solid #6366f1; }
    </style>
</head>

<body x-data="istuApp" class="min-h-screen flex flex-col">

    <nav class="bg-white border-b border-gray-200 py-4 px-6 flex justify-between items-center sticky top-0 z-50">
        <div class="font-bold text-2xl text-indigo-600 tracking-tight cursor-pointer" @click="view = 'dashboard'">
            üéì ISTU
        </div>
        <button @click="clearData()" class="text-xs text-gray-400 hover:text-red-500 transition">Reset Data</button>
    </nav>

    <main class="flex-1 max-w-3xl w-full mx-auto p-6">
        
        <div x-show="view === 'dashboard'">
            <div class="bg-indigo-600 text-white p-8 rounded-2xl shadow-lg mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold">Welcome back!</h1>
                    <p class="text-indigo-100 opacity-90">Ready to master your Logistics knowledge?</p>
                </div>
                <button @click="view = 'create'" class="bg-white text-indigo-600 px-6 py-2.5 rounded-lg font-bold hover:bg-indigo-50 transition shadow-md whitespace-nowrap">
                    + New Deck
                </button>
            </div>

            <div x-show="decks.length === 0" class="text-center py-12 border-2 border-dashed border-gray-200 rounded-xl">
                <p class="text-gray-400">No decks found. Create your first AI deck now.</p>
            </div>

            <div class="grid gap-4">
                <template x-for="deck in decks" :key="deck.id">
                    <div class="bg-white p-6 rounded-xl border border-gray-100 hover:border-indigo-500 hover:shadow-md transition cursor-pointer flex justify-between items-center group" @click="startSession(deck.id)">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 group-hover:text-indigo-600 transition" x-text="deck.topic"></h3>
                            <div class="flex items-center gap-2 mt-2 text-sm text-gray-500">
                                <span class="bg-gray-100 px-2 py-0.5 rounded" x-text="deck.cards.length + ' cards'"></span>
                                <span x-show="getDueCount(deck) > 0" class="text-red-500 font-semibold flex items-center gap-1">
                                    ‚óè <span x-text="getDueCount(deck)"></span> due
                                </span>
                                <span x-show="getDueCount(deck) === 0" class="text-green-600 flex items-center gap-1">
                                    ‚óè Completed
                                </span>
                            </div>
                        </div>
                        <span class="text-gray-300 text-2xl group-hover:translate-x-1 transition">‚Üí</span>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="view === 'create'" x-cloak>
            <button @click="view = 'dashboard'" class="mb-6 text-sm text-gray-500 hover:text-gray-900 flex items-center gap-1">‚Üê Back to Dashboard</button>
            
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
                <h2 class="text-xl font-bold mb-6 text-gray-800">Generate Flashcards</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Topic</label>
                        <input x-model="inputTopic" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="e.g., Incoterms 2020, Warehouse Operations...">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                        <input x-model="apiKey" type="password" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm" placeholder="Paste your AIza... key here">
                    </div>

                    <button @click="handleGenerate()" :disabled="loading" class="w-full bg-indigo-600 text-white py-3.5 rounded-lg font-bold hover:bg-indigo-700 disabled:opacity-70 disabled:cursor-not-allowed transition flex justify-center items-center gap-2 mt-4">
                        <svg x-show="loading" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span x-text="loading ? 'Generating...' : 'Create with AI'"></span>
                    </button>
                </div>
            </div>
        </div>

        <div x-show="view === 'study'" x-cloak class="flex flex-col items-center max-w-lg mx-auto">
            <div class="w-full flex justify-between items-center mb-8">
                <button @click="view = 'dashboard'" class="text-gray-400 hover:text-gray-800 transition">‚úï Exit</button>
                <span class="font-mono bg-gray-100 text-gray-600 px-3 py-1 rounded text-sm" x-text="(sessionIndex + 1) + ' / ' + sessionCards.length"></span>
            </div>

            <template x-if="sessionCards.length > 0 && sessionIndex < sessionCards.length">
                <div class="w-full">
                    <div class="card-wrap group mb-8" :class="isFlipped ? 'flipped' : ''" @click="isFlipped = !isFlipped">
                        <div class="card-inner">
                            <div class="face front">
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-widest absolute top-6">Question</span>
                                <h3 class="text-2xl font-bold text-gray-800" x-text="sessionCards[sessionIndex].front"></h3>
                                <span class="text-xs text-gray-300 absolute bottom-6">Tap to flip</span>
                            </div>
                            <div class="face back">
                                <span class="text-xs font-bold text-indigo-300 uppercase tracking-widest absolute top-6">Answer</span>
                                <p class="text-xl font-medium" x-text="sessionCards[sessionIndex].back"></p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3" x-show="isFlipped" x-transition.opacity>
                        <button @click="rate('hard')" class="py-3 bg-red-50 text-red-600 rounded-lg font-bold border border-red-100 hover:bg-red-100 transition">Hard</button>
                        <button @click="rate('good')" class="py-3 bg-yellow-50 text-yellow-600 rounded-lg font-bold border border-yellow-100 hover:bg-yellow-100 transition">Good</button>
                        <button @click="rate('easy')" class="py-3 bg-green-50 text-green-600 rounded-lg font-bold border border-green-100 hover:bg-green-100 transition">Easy</button>
                    </div>
                </div>
            </template>

            <template x-if="sessionIndex >= sessionCards.length">
                <div class="text-center mt-12 animate-fade-in">
                    <div class="text-6xl mb-6">üéâ</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Session Complete!</h3>
                    <p class="text-gray-500 mb-8">You've reviewed all scheduled cards.</p>
                    <button @click="view = 'dashboard'" class="bg-indigo-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-indigo-700 transition">Return to Dashboard</button>
                </div>
            </template>
        </div>
    </main>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('istuApp', () => ({
                view: 'dashboard',
                decks: [],
                inputTopic: '',
                apiKey: localStorage.getItem('istu_apikey') || '',
                loading: false,
                sessionCards: [],
                sessionIndex: 0,
                isFlipped: false,
                currentDeckId: null,

                init() {
                    // Load persistent data
                    const saved = localStorage.getItem('istu_data');
                    if (saved) this.decks = JSON.parse(saved);
                    
                    // Auto-save API key
                    this.$watch('apiKey', (val) => localStorage.setItem('istu_apikey', val));
                },

                save() {
                    localStorage.setItem('istu_data', JSON.stringify(this.decks));
                },

                async handleGenerate() {
                    if (!this.inputTopic) return alert("Please enter a topic.");
                    if (!this.apiKey) return alert("API Key is required.");
                    
                    this.loading = true;
                    try {
                        // Invoke the AI module attached to window
                        const cards = await window.generateFromGemini(this.inputTopic, this.apiKey);
                        
                        // Add SRS metadata to new cards
                        const processedCards = cards.map(c => ({ 
                            ...c, 
                            id: Math.random().toString(36).substr(2, 9), 
                            nextReview: Date.now() 
                        }));

                        this.decks.unshift({ 
                            id: Date.now(), 
                            topic: this.inputTopic, 
                            cards: processedCards 
                        });
                        
                        this.save();
                        this.inputTopic = '';
                        this.view = 'dashboard';
                    } catch (e) {
                        alert("AI Error: " + e.message);
                    } finally {
                        this.loading = false;
                    }
                },

                startSession(id) {
                    this.currentDeckId = id;
                    const deck = this.decks.find(d => d.id === id);
                    // Filter due cards
                    this.sessionCards = deck.cards.filter(c => c.nextReview <= Date.now());
                    
                    if(this.sessionCards.length === 0) return alert("No cards due for review in this deck.");
                    
                    this.sessionIndex = 0;
                    this.isFlipped = false;
                    this.view = 'study';
                },

                rate(level) {
                    const currentCardId = this.sessionCards[this.sessionIndex].id;
                    const deck = this.decks.find(d => d.id === this.currentDeckId);
                    const card = deck.cards.find(c => c.id === currentCardId);
                    
                    // Simple SRS Algorithm
                    // Hard: 10 mins | Good: 1 day | Easy: 3 days
                    const intervalHours = level === 'hard' ? 0.16 : (level === 'good' ? 24 : 72);
                    card.nextReview = Date.now() + (intervalHours * 3600000);
                    
                    this.save();
                    this.isFlipped = false;
                    this.sessionIndex++;
                },

                getDueCount(deck) {
                    return deck.cards.filter(c => c.nextReview <= Date.now()).length;
                },

                clearData() {
                    if(confirm("Are you sure you want to wipe all data?")) { 
                        localStorage.removeItem('istu_data'); 
                        location.reload(); 
                    }
                }
            }))
        })
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        window.generateFromGemini = async (topic, key) => {
            const genAI = new GoogleGenerativeAI(key);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            
            // Strict JSON prompt
            const prompt = `Create 5 flashcards about: "${topic}". 
            Output strictly a JSON Array: [{"front": "Question", "back": "Short Answer"}]. 
            Language: Vietnamese (unless topic implies English). No markdown tags.`;

            const result = await model.generateContent(prompt);
            const text = result.response.text();
            
            // Cleanup JSON response
            const jsonText = text.replace(/```json|```/g, "").trim();
            return JSON.parse(jsonText);
        }
    </script>
</body>
</html>